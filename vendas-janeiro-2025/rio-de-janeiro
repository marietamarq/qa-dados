WITH payments_rejected AS (
  SELECT w.person_id,
         SUM(p.amount_paid) AS rejected_amount_paid
  FROM prod_lake_ss_refined.payments p
  LEFT JOIN prod_lake_ss_refined.wallets w ON w.id = p.wallet_id
  WHERE p.state = 'rejected'
  GROUP BY w.person_id
),
payments_scheduled AS (
  SELECT w.person_id,
         SUM(p.amount_paid) AS scheduled_amount_paid
  FROM prod_lake_ss_refined.payments p
  LEFT JOIN prod_lake_ss_refined.wallets w ON w.id = p.wallet_id
  WHERE p.state = 'scheduled'
  GROUP BY w.person_id
),
payments_payed AS (
  SELECT w.person_id,
         SUM(p.amount_paid) AS payed_amount_paid
  FROM prod_lake_ss_refined.payments p
  LEFT JOIN prod_lake_ss_refined.wallets w ON w.id = p.wallet_id
  WHERE p.state = 'payed'
  GROUP BY w.person_id
),
count_payed AS (
		SELECT 
			w.person_id,
			COUNT(due_at) AS pagos
			FROM prod_lake_ss_refined.payments p
  			LEFT JOIN prod_lake_ss_refined.wallets w ON w.id = p.wallet_id
			WHERE p.state = 'payed'
				AND p.created_at >= DATE '2025-01-01'
		      	AND p.created_at <  DATE '2025-02-01'
			GROUP BY 1
),
count_rejected AS (
		SELECT 
			w.person_id,
			COUNT(due_at) AS rejeitados
			FROM prod_lake_ss_refined.payments p
  			LEFT JOIN prod_lake_ss_refined.wallets w ON w.id = p.wallet_id
			WHERE p.state = 'rejected'
				AND p.created_at >= DATE '2025-01-01'
		      	AND p.created_at <  DATE '2025-02-01'
			GROUP BY 1
),
count_scheduled AS (
		SELECT 
			w.person_id,
			COUNT(due_at) AS agendados
			FROM prod_lake_ss_refined.payments p
  			LEFT JOIN prod_lake_ss_refined.wallets w ON w.id = p.wallet_id
			WHERE p.state = 'scheduled'
				AND p.created_at >= DATE '2025-01-01'
		      	AND p.created_at <  DATE '2025-02-01'
			GROUP BY 1
),
acessos_por_pessoa AS (
       SELECT 
	        person_id,
			COUNT(*) AS quantidade_acessos
		    FROM prod_lake_ss_refined.accesses
		    WHERE created_at >= DATE '2024-10-01'
		      AND created_at <  DATE '2025-02-01'
		    GROUP BY 1
),
guests_por_pessoa AS (
	    SELECT 
	        person_id,
	        COUNT(*) AS total_guests
		    FROM prod_lake_ss_refined.guests
		    WHERE id IS NOT NULL
				AND created_at >= DATE '2024-10-01'
				AND created_at <  DATE '2025-02-01'
		    GROUP BY person_id
),
ranked_purchases AS (
    SELECT 
        p.*,
        ROW_NUMBER() OVER (
            PARTITION BY p.person_id 
            ORDER BY p.created_at DESC, p.id DESC
        ) AS rn
    FROM prod_lake_ss_refined.purchases p
),
last_purchase AS (
    SELECT *
    FROM ranked_purchases
    WHERE rn = 1
)

SELECT 
	MAX(pe.id) AS person_id,
	MAX(p.id) AS purchase_id,
	MAX(pe.name) AS name,
	MAX (p.expired_at) AS expired_at,
	MAX(m.end_at) AS cancelamento_matricula,
	MAX(p.created_at) as purchase_created,
    MAX(pe.email) AS email,
    MAX(pe.document_cpf) AS document_cpf,
    MAX(pc.brand) AS wallet_brand,
    MAX(CASE 
        WHEN (
            SELECT COUNT(DISTINCT p2.id) 
            FROM prod_lake_ss_refined.purchases p2 
            WHERE p2.person_id = p.person_id
              AND p2.id <> p.id
              AND p2.created_at < p.created_at
        ) = 0 THEN false
        ELSE true
    END) AS rebuy,
    MAX (CASE 
        WHEN pe.document_cpf = w.responsible_cpf THEN 'positivo' 
        ELSE 'negativo'
    END) AS documento_paymentmethod_wallet, 
    MAX (CASE 
        WHEN p.cancelled IS NULL THEN 'ativo'
        ELSE 'cancelado'
    END) AS cancelamento_purchase,
	MAX (CASE 
        WHEN pe.cached_status = 'active' THEN 'ativo'
        ELSE 'inativo'
    END) AS cached_status,
	MAX (CASE
		WHEN re.state = 'payed' THEN 'payed'
		ELSE 'null'
	END) AS abono,
	MAX(re.amount_paid) AS abono_amount_paid,
	a.quantidade_acessos, --16
	g.total_guests,
	p.kind,
	pr.rejected_amount_paid AS rejected_amount_paid,
	ps.scheduled_amount_paid AS scheduled_amount_paid,
	pp.payed_amount_paid AS payed_amount_paid,
	cp.pagos AS count_payed,
	cr.rejeitados AS count_rejected,
	cs.agendados AS count_scheduled
FROM last_purchase p 
LEFT JOIN prod_lake_ss_refined.locations 			l ON p.location_id = l.id
LEFT JOIN prod_lake_ss_refined.cities    			cy ON l.city_id = cy.id
LEFT JOIN prod_lake_ss_refined.states    			s ON cy.state_id = s.id
LEFT JOIN prod_lake_ss_refined.people    			pe ON pe.id = p.person_id
LEFT JOIN prod_lake_ss_refined.wallets   			w ON w.person_id = pe.id
LEFT JOIN prod_lake_ss_refined.memberships 			m ON p.id = m.purchase_id
LEFT JOIN prod_lake_ss_refined.payment_companies 	pc ON pc.id = w.payment_company_id
LEFT JOIN (
  SELECT purchase_id, MAX(state) AS state, SUM(amount_paid) AS amount_paid
  FROM prod_lake_ss_refined.refunds
  GROUP BY purchase_id
) re ON re.purchase_id = p.id
LEFT JOIN acessos_por_pessoa a ON a.person_id = pe.id
LEFT JOIN guests_por_pessoa g ON g.person_id = pe.id
LEFT JOIN payments_rejected   pr ON pr.person_id = p.person_id
LEFT JOIN payments_scheduled  ps ON ps.person_id = p.person_id
LEFT JOIN payments_payed      pp ON pp.person_id = p.person_id
LEFT JOIN count_payed         cp ON cp.person_id = p.person_id
LEFT JOIN count_rejected      cr ON cr.person_id = p.person_id
LEFT JOIN count_scheduled     cs ON cs.person_id = p.person_id
WHERE 
	p.created_at >= DATE '2025-01-01'
	AND p.created_at <  DATE '2025-02-01'
	AND LOWER(pe.name) NOT LIKE '%teste%'
	AND pe.foreigner = FALSE
	AND s.id = 14
	AND p.plan_id IN (1,2,150)
	AND pe.id IN (48 mil person_ids...)
GROUP BY 16,17,18,19,20,21,22,23,24
ORDER BY purchase_created asc
